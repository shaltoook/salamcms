<?php
function get_logo() {
	return '<svg
   width="70.556221mm"
   height="91.295456mm"
   viewBox="0 0 70.556219 91.295454"
   version="1.1"
   id="svg1"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs1" />
  <g
     id="layer1"
     transform="translate(-61.925133,-69.2704)">
    <path
       id="path1"
       style="fill:#000000;stroke-width:0.264583"
       d="m 95.307367,69.270614 c -3.91086,-0.0043 -4.397958,0.05032 -6.391858,0.716235 -11.37873,3.800207 -14.258836,17.973304 -5.443596,26.788546 1.82152,1.821519 5.135708,4.041395 8.028968,5.377965 2.43423,1.12451 10.025669,3.942 12.537739,4.65346 2.57518,0.72933 8.5657,3.03243 10.84791,4.17029 3.14931,1.57017 6.27916,3.73408 8.33851,5.76502 4.37155,4.31126 6.43337,9.30898 6.43837,15.60629 0.006,7.03384 -2.19326,12.48442 -6.91121,17.13177 -2.31308,2.27848 -3.15588,2.78711 -2.19263,1.32292 1.84537,-2.80509 3.57645,-7.40252 3.87005,-10.27638 0.16646,-1.62941 0.23576,-1.77393 1.05833,-2.21692 0.97818,-0.52678 1.70171,-1.79603 1.70171,-2.98586 0,-1.03753 -1.00221,-2.48064 -2.07688,-2.99052 -0.74898,-0.35535 -0.96434,-0.69973 -1.5782,-2.52543 -0.39094,-1.16272 -1.12727,-2.81481 -1.63659,-3.67161 -1.20737,-2.03108 -4.68842,-5.53315 -6.94531,-6.98717 -1.78126,-1.14785 -1.78649,-1.15384 -1.78749,-2.3766 -0.002,-1.51411 -0.75615,-2.55337 -2.21588,-3.05252 -1.29227,-0.4419 -2.66033,-0.16224 -3.54707,0.7245 l -0.65423,0.65422 -9.027871,-3.02565 c -6.55797,-2.19787 -9.970747,-3.49325 -12.475207,-4.73511 -6.31832,-3.13298 -10.123921,-6.92289 -11.912451,-11.862327 l -0.582911,-1.609721 1.059367,-0.939994 c 0.91468,-0.811705 1.074655,-1.119646 1.173055,-2.256193 0.1392,-1.608608 -0.47287,-2.73812 -1.83348,-3.383773 l -0.921907,-0.4377 0.250631,-1.377176 c 0.13766,-0.757436 0.535947,-2.135968 0.885217,-3.063896 2.07247,-5.506042 4.987633,-8.763004 10.161653,-11.353312 2.15994,-1.081348 1.704122,-1.114421 -1.333768,-0.09663 -11.9432,4.001339 -19.161365,14.331959 -17.979265,25.731762 1.13805,10.975 8.688972,17.91459 25.407752,23.35154 1.23693,0.40225 2.3406,0.81453 2.45308,0.91622 0.11248,0.10168 0.02152,0.62382 -0.202571,1.16014 -0.44959,1.07603 -0.31987,2.04765 0.35295,2.64377 0.24157,0.21403 1.752554,0.94437 3.357934,1.62264 3.40334,1.43789 3.978926,1.39323 4.881352,-0.37569 l 0.54571,-1.0697 1.64796,0.82372 c 2.76912,1.38409 5.86897,3.58188 7.42849,5.26634 2.84356,3.07138 3.85265,5.53812 4.06796,9.94565 l 0.14366,2.93729 -2.08101,0.86661 c -4.30673,1.79289 -10.69908,2.38132 -15.753555,1.45056 -6.99419,-1.28794 -14.596143,-5.07075 -21.745443,-10.82104 -2.47947,-1.99424 -2.576794,-2.1118 -2.401404,-2.89957 0.60888,-2.7347 -0.712181,-4.65708 -3.200321,-4.65708 -2.05236,0 -3.307292,1.34249 -3.307292,3.53829 0,2.23051 2.108609,3.74401 4.301029,3.08715 1.02581,-0.30734 1.087295,-0.28931 2.016415,0.58962 4.47477,4.23305 11.722737,8.62898 17.820617,10.80813 4.39834,1.5718 7.597416,2.13864 12.109854,2.14664 4.31768,0.008 6.77529,-0.40472 9.83919,-1.65158 1.04432,-0.42498 1.93953,-0.7332 1.99523,-0.68678 l 5.2e-4,5.2e-4 c 0.1604,0.1604 -1.05329,3.17561 -1.67949,4.17235 -0.49714,0.79131 -0.89233,1.05352 -2.14147,1.41955 -6.13227,1.79691 -13.685364,1.55199 -20.780124,-0.67334 -2.52049,-0.79056 -2.579688,-0.82756 -2.579688,-1.61385 0,-1.10387 -1.259595,-2.35128 -2.374015,-2.35128 -0.45499,0 -1.177507,0.18067 -1.605587,0.40204 -0.73131,0.37817 -0.862603,0.36024 -2.169893,-0.29869 -1.87936,-0.94726 -4.643862,-2.74699 -7.153052,-4.65708 -1.93064,-1.46965 -2.063464,-1.6333 -1.906344,-2.34869 0.49546,-2.25582 -1.696761,-4.12539 -3.660241,-3.12126 -1.69159,0.86508 -2.029152,2.92455 -0.697632,4.25607 0.72542,0.72539 0.928987,0.79265 2.028817,0.66869 1.16274,-0.13106 1.301588,-0.0724 2.831868,1.20355 1.85026,1.54273 5.596249,4.05088 7.824329,5.23844 1.37096,0.73071 1.545816,0.91947 1.691886,1.83296 0.21008,1.31375 1.191069,2.11563 2.588989,2.11563 0.56758,0 1.29568,-0.1719 1.61799,-0.38188 0.52545,-0.34232 0.851476,-0.30275 3.157946,0.38447 5.61191,1.67208 10.417154,2.26502 15.047141,1.85725 1.66013,-0.1462 3.67294,-0.43614 4.47311,-0.64441 0.80017,-0.20824 1.50492,-0.32805 1.56632,-0.26665 0.20309,0.2031 -1.1312,1.4433 -2.60501,2.42156 -0.79824,0.52984 -2.45851,1.3104 -3.6897,1.73478 -1.90684,0.65726 -2.65361,0.77343 -5.038968,0.78393 -7.78135,0.0342 -17.51823,-3.34504 -25.95087,-9.00617 l -3.042709,-2.04225 -0.03669,-1.21285 c -0.07265,-2.41047 -1.550438,-3.94498 -3.799768,-3.94498 -2.95775,0 -4.733872,2.74904 -3.466972,5.36609 0.77808,1.6073 1.848301,2.15284 3.885551,1.98127 1.50548,-0.1268 1.626596,-0.0885 3.153296,0.99115 7.88943,5.57917 17.40795,9.49556 25.4,10.45105 4.41317,0.52761 9.47412,-0.23059 12.57649,-1.88413 4.32515,-2.30529 7.85872,-6.89089 9.15448,-11.87989 0.60465,-2.32786 0.61213,-7.21674 0.0145,-9.525 -0.78218,-3.0209 -2.44596,-5.94295 -4.67,-8.20054 -2.17476,-2.20757 -4.23688,-3.64788 -7.63777,-5.33507 -1.93643,-0.96069 -2.18145,-1.16048 -2.02262,-1.65003 0.3705,-1.14195 0.43237,-2.23289 0.15606,-2.74919 -0.34793,-0.65012 -5.704676,-2.96726 -6.859526,-2.96726 -0.82385,0 -1.902209,0.99515 -1.902209,1.75545 0,0.19866 -0.176241,0.36122 -0.391191,0.36122 -0.81121,0 -10.168152,-3.54638 -12.678812,-4.80539 -3.40306,-1.70652 -5.429404,-3.09085 -7.657414,-5.23069 -3.10754,-2.98458 -5.07043,-6.5539 -5.74797,-10.451552 -0.38499,-2.214718 -0.190008,-6.508329 0.397392,-8.74882 0.61166,-2.333009 2.618302,-6.238248 3.962032,-7.710641 l 1.173055,-1.285193 -0.762744,2.171961 c -0.41962,1.19476 -0.83956,2.74714 -0.93276,3.449918 -0.1369,1.031978 -0.312479,1.360304 -0.913639,1.705323 -2.42151,1.389758 -2.265136,4.913979 0.266134,5.994982 0.87036,0.371697 1.063942,0.622308 1.460893,1.887741 0.959059,3.057353 2.285433,5.195201 4.816243,7.763861 4.00867,4.06862 8.151915,6.14549 20.574455,10.31255 l 8.989111,3.01532 0.20671,0.9927 c 0.56531,2.72087 3.04875,3.76597 5.52628,2.32544 0.6623,-0.38508 0.76312,-0.35708 2.24637,0.6258 2.2953,1.521 4.96644,4.15239 6.20324,6.11074 0.97274,1.54023 2.36678,4.70209 2.36678,5.36867 0,0.13846 -0.35551,0.43542 -0.78961,0.65991 -2.28664,1.18246 -2.041,5.11132 0.37413,5.98464 1.08005,0.39055 1.06868,0.33233 0.56948,2.94143 -0.83315,4.3545 -3.493,9.33986 -6.84661,12.83229 -1.61664,1.68357 -4.62367,3.78972 -7.14789,5.00641 l -1.37304,0.66198 1.05833,-0.16485 c 1.75531,-0.27335 6.23065,-1.72659 8.20209,-2.66341 10.02064,-4.76172 15.7427,-13.66861 15.7427,-24.50444 0,-6.64821 -2.15754,-12.25686 -6.48229,-16.85169 -4.54331,-4.82705 -9.55069,-7.59141 -20.37291,-11.24737 -12.924283,-4.36607 -16.893523,-6.284556 -20.386873,-9.853661 -2.30919,-2.359263 -4.087089,-6.037933 -4.087089,-8.456331 0,-0.763923 0.129214,-0.901204 1.342554,-1.423169 3.32183,-1.429012 5.078765,-1.717807 10.431405,-1.714107 4.26834,0.0029 5.371778,0.08995 7.313253,0.576709 5.06457,1.269769 9.79059,3.267495 14.6823,6.206339 2.5826,1.55159 2.74706,1.700966 2.60139,2.364197 -0.24474,1.114277 0.32843,2.756269 1.22525,3.510897 0.95824,0.8063 2.70769,0.922838 3.97961,0.2651 1.18372,-0.612122 1.92653,-2.422835 1.55701,-3.795117 -0.55299,-2.053664 -2.8299,-3.145759 -4.75217,-2.278931 l -1.00872,0.454753 -2.74505,-1.660364 c -8.09955,-4.899583 -15.51669,-7.209894 -23.117457,-7.200594 -4.03707,0.005 -6.767367,0.450018 -9.546187,1.555977 -0.88454,0.352044 -1.688238,0.640271 -1.785938,0.640271 -0.31028,0 -0.160741,-1.405811 0.308509,-2.902148 l 0.453719,-1.446424 1.737878,-0.596346 c 3.96816,-1.361332 9.883456,-1.762181 14.882296,-1.008724 3.83918,0.578668 4.66535,0.841979 4.66535,1.486215 0,0.296627 0.34771,0.887205 0.77308,1.312581 0.93834,0.93834 2.51479,1.062777 3.48712,0.275435 0.70981,-0.574772 0.55797,-0.617875 4.77491,1.361158 2.73101,1.281692 2.81791,1.348736 2.81791,2.181779 0,1.142524 0.43132,1.890432 1.37046,2.376082 0.97643,0.504926 1.42067,0.502575 2.42052,-0.01447 1.79512,-0.92829 1.87374,-3.573559 0.13746,-4.632276 -0.97215,-0.59278 -1.64258,-0.628503 -2.53369,-0.134875 -0.58589,0.324551 -0.86712,0.247122 -3.175,-0.875399 -1.39269,-0.677386 -3.03817,-1.427563 -3.65663,-1.667082 -0.70246,-0.272048 -1.12448,-0.601973 -1.12448,-0.879016 0,-0.824878 -0.9003,-1.974367 -1.77146,-2.261877 -0.99591,-0.328678 -1.82489,-0.141994 -2.62827,0.592212 -0.53388,0.487897 -0.64294,0.493901 -2.11666,0.116272 -4.466113,-1.144397 -12.22497,-1.241576 -16.36903,-0.204639 -1.16354,0.291142 -2.175558,0.468444 -2.248958,0.393774 -0.07339,-0.07467 0.598262,-0.824952 1.492932,-1.667081 4.396,-4.137864 10.182724,-4.725435 19.937286,-2.024683 5.11968,1.41749 10.93363,4.02666 15.74891,7.067786 1.56805,0.990312 1.71359,1.159834 1.71359,1.995227 0,1.230619 0.83248,2.774001 1.80144,3.339331 1.13201,0.660453 2.94391,0.598442 4.04626,-0.137976 2.6632,-1.779137 2.25104,-5.566674 -0.72967,-6.705017 -1.12131,-0.428238 -1.32,-0.433874 -2.34404,-0.06563 l -1.11931,0.40256 -2.08411,-1.300179 c -3.09653,-1.931043 -9.60606,-5.035037 -13.07414,-6.234245 -1.67876,-0.580488 -4.47673,-1.387604 -6.21771,-1.793689 -2.759249,-0.643604 -3.708383,-0.739007 -7.398513,-0.743107 z m 10.761613,8.043953 c 0.36947,-0.01348 0.72888,0.08757 0.95912,0.317811 0.47447,0.474461 0.38307,1.657642 -0.1664,2.154907 -0.64301,0.581917 -1.25321,0.552872 -1.89704,-0.09095 -0.63683,-0.636831 -0.66165,-1.016526 -0.11731,-1.793689 0.25525,-0.364406 0.74661,-0.570748 1.22163,-0.588079 z m 19.92023,2.69441 c 0.14008,-0.0035 0.29373,0.01587 0.47801,0.05116 0.9836,0.188349 2.30994,1.508394 2.30994,2.299085 0,0.761323 -0.70697,2.034025 -1.30845,2.355928 -1.49761,0.801497 -3.35305,-0.171667 -3.62872,-1.903243 -0.13987,-0.878618 -0.0524,-1.089605 0.80822,-1.950268 0.62444,-0.624441 0.92078,-0.842247 1.341,-0.852661 z m -8.14627,2.862357 c 1.21209,0 1.83043,1.652805 0.92501,2.472201 -0.94413,0.854427 -2.42621,0.205153 -2.42621,-1.062984 0,-0.664716 0.79312,-1.409217 1.5012,-1.409217 z m -46.282961,5.296318 c 0.52744,-0.02676 1.071766,0.181897 1.534273,0.644405 0.80339,0.803386 0.843516,1.943054 0.101286,2.886645 -0.73651,0.936329 -2.12555,0.958504 -3.03599,0.04806 -0.70983,-0.709826 -0.817712,-1.45059 -0.341582,-2.344559 0.413393,-0.776178 1.063876,-1.200152 1.742013,-1.23455 z m 49.315851,2.631364 c 0.59393,-0.0081 1.19464,0.270851 1.65985,0.823722 0.37673,0.447725 0.68523,0.975411 0.68523,1.173055 0,0.818165 -0.55548,1.716867 -1.29863,2.101164 -0.94912,0.490807 -1.03285,0.494215 -1.86862,0.07131 -1.45404,-0.735753 -1.68986,-2.499799 -0.48421,-3.623034 0.38641,-0.359992 0.84444,-0.539929 1.30638,-0.54622 z m -10.90941,23.872964 c 0.68015,0.0166 1.31758,0.44555 1.73788,1.25832 0.51616,0.99814 0.30332,1.96315 -0.58756,2.66392 -0.90026,0.70814 -1.95924,0.66123 -2.80655,-0.12403 -0.96676,-0.89596 -0.93886,-2.06355 0.0734,-3.07578 0.49889,-0.49889 1.05384,-0.73538 1.58285,-0.72243 z m -14.470951,2.97191 c 0.504354,-0.0113 5.222871,1.88816 5.605861,2.26963 0.14067,0.14011 -0.27858,1.43236 -1.02578,3.16105 -0.695079,1.60812 -1.397247,2.91266 -1.560627,2.89956 -0.81023,-0.0653 -5.456515,-2.24561 -5.456515,-2.56057 0,-0.48341 2.130501,-5.59469 2.401921,-5.76244 0.0072,-0.004 0.01887,-0.007 0.03514,-0.007 z m -26.246977,11.26494 c 0.8037,0 2.114083,1.39383 2.114083,2.24896 0,0.42329 -0.307356,1.00911 -0.773596,1.47536 -0.90457,0.90457 -1.796007,0.98574 -2.733167,0.24857 -0.88448,-0.69573 -1.103529,-1.66601 -0.597379,-2.6448 0.45064,-0.87144 1.135189,-1.32809 1.990059,-1.32809 z m 54.533618,4.32791 c 0.55782,4.4e-4 1.08327,0.25281 1.54823,0.75189 0.7781,0.8352 0.68564,1.95502 -0.23719,2.87786 -0.85174,0.85174 -1.39755,0.93838 -2.41691,0.38395 -1.53102,-0.83273 -1.49052,-2.93318 0.0723,-3.74137 0.35229,-0.18218 0.69884,-0.2726 1.03352,-0.27233 z m -54.824556,4.41316 c 0.404865,-0.003 0.820893,0.0995 1.028878,0.30748 0.52627,0.52627 0.377562,1.72698 -0.270268,2.18074 -0.77702,0.54424 -0.909723,0.52584 -1.670183,-0.23461 -0.63907,-0.63903 -0.652359,-1.15424 -0.04961,-1.93321 0.162835,-0.21044 0.556317,-0.31771 0.961183,-0.3204 z m -3.037024,5.28547 c 0.563028,0.0218 1.121678,0.24576 1.569413,0.6935 0.94656,0.94657 0.959376,2.40786 0.02946,3.33778 -1.31529,1.31528 -3.275402,0.95624 -3.979602,-0.72916 -0.35286,-0.84438 -0.35083,-1.03802 0.02222,-1.82418 0.469307,-0.98898 1.420133,-1.51435 2.358513,-1.47794 z m 18.188037,4.89066 c 0.170223,0.009 0.348806,0.0574 0.531234,0.15347 1.1512,0.60653 1.334887,1.5068 0.481107,2.36058 -0.63683,0.63683 -1.016002,0.66113 -1.793172,0.11679 -1.191356,-0.83447 -0.41073,-2.69403 0.780831,-2.63084 z" />
  </g>
</svg>';
}

function show_menu($items, $active_level = 1) {
	foreach($items as $level => $item) {
		$menu_class = 'normalMenu';
		if($active_level > $level) {
			$menu_class = 'passedMenu';
		} elseif($active_level == $level) {
			$menu_class = 'currentMenu';
		}

		echo '<div class="menuItem '.$menu_class .'">';
		echo '<span>'.$item.'</span>';
		echo '</div>';
	}
}

function get_string($key, $var = array()) {
	global $dict, $lang;
	
	if(isset($dict[$lang][$key])) {
		$output = $dict[$lang][$key];
		foreach($var as $key => $val) {
			$output = str_replace('{'.$key.'}', $val, $output);
		}
	} else {
		$output = '[['.$key.']]';
	}
	return $output;
}

function set_sess($key, $val) {
	$_SESSION[$key] = $val;
}

function set_notif($content, $type = 'error') {
	$_SESSION['notifs'][] = array(
		'content' => $content,
		'type' => $type
	);
}

function unset_sess($key) {
	unset($_SESSION[$key]);
}

function sess($key) {
	return ($_SESSION[$key]) ?? false;
}

function req($key) {
	return ($_REQUEST[$key]) ?? false;
}

function get_lang() {
	return (sess('lang')) ? sess('lang') : 'en';
}

function get_current_level() {
	return (sess('current_level')) ? sess('current_level') : '1';
}

function get_dir() {
	global $lang;
	
	return (in_array($lang,array('en'))) ? 'ltr' : 'rtl';
}

function get_version() {
	if(file_exists('version.php')) {
		include('version.php');
		return $version;
	}
	return false;
}

function get_level_1() {
	global $lang;
	
	$output = '<p>'.get_string('level1note').'</p>';
	$output .= '<div id="formWrapper">';
	$e = new stdClass();
	$e->type = 'select';
	$e->label = get_string('language');
	$e->name = 'lang';
	$e->options = array(
		'fa' => get_string('fa'),
		'en' => get_string('en')
	);
	$e->value = $lang;
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'select';
	$e->label = get_string('cmsversion');
	$e->name = 'version';
	$options = array();
	$versions = get_versions();
	foreach($versions as $version) {
		$options[$version['id']] = $version['title'];
	}
	$e->options = $options;
	if(sess('version'))
		$e->value = sess('version');
	$output .= form_input($e); 
	
	$output .= '</div>';
	echo $output;
}

function process_level_1() {
	if(req('version')) {
		$versions = get_versions();
		$php_ver = $versions[req('version')]['requirement']['php'];
		
		if(check_php_version($php_ver)) {
			set_sess('version', req('version'));
			$clevel = 2;
		} else {
			$clevel = 1;
		}
		set_sess('current_level', $clevel);
	}
}

function show_notifications() {
	if(sess('notifs')) {
		foreach(sess('notifs') as $notif) {
			echo '<div class="alert '.$notif['type'].'Alert">' . $notif['content'] . '</div>';
		}
		unset_sess('notifs');
	}
}

function get_base_url() {
    $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
    $host = $_SERVER['HTTP_HOST'];
    return $protocol . $host;
}

function get_www_root() {
    return __DIR__;
}

function get_data_root() {
    return __DIR__;
}

function get_level_2() {	
	$output = '<p>'.get_string('level2note').'</p>';
	$output .= '<div id="formWrapper">';
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('projectname');
	$e->name = 'projectname';
	if(sess('projectname')) $e->value = sess('projectname');
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('url');
	$e->name = 'url';
	$e->value = (sess('url')) ?: get_base_url();
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('wwwroot');
	$e->name = 'wwwroot';
	$e->value = (sess('wwwroot')) ?: get_www_root();
	$e->additional = '<span class="extraLink" id="wwwrootValidator">'.get_string('validate').'</span>';
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dataroot');
	$e->name = 'dataroot';
	$e->value = (sess('dataroot')) ?: get_data_root();
	$e->additional = '<span class="extraLink" id="datarootValidator">'.get_string('validate').'</span>';
	$output .= form_input($e); 
	
	$output .= '</div>';
	echo $output;
}

function process_level_2() {
	if(validate_param('projectname','url','wwwroot','dataroot')) {
		$clevel = 3;
	} else {
		$clevel = 2;
	}
	
	set_sess('current_level', $clevel);
}

function get_level_3() {
	
	$show_download_btn = true;
	
	if(get_version()) {
		$output = '<p>'.get_string('level3note3').'</p>';
	} else {
		$checks = check_download_requirements();

		if (array_sum($checks) === count($checks)) {
			$output = '<p>'.get_string('level3note1').'</p>';
		} else {
			$output = '<div class="alert errorAlert">';
			$output .= get_string('level3note2');
			$output .= '<ul>';
			foreach ($checks as $key => $ok) {
				if(!$ok)
					$output .= '<li>'.get_string('failed'.$key).'</li>';
			}
			$output .= '</ul>';
			$output .= '</div>';
			$show_download_btn = false;
		}
	}
	
	if($show_download_btn) {
		$output .= '<div><button>Start Download</button></div>';
	}	

	echo $output;
}

function process_level_3() {
	set_sess('current_level', 4);
}

function get_level_4() {	
	$output = '<p>'.get_string('level4note').'</p>';
	$output .= '<div id="formWrapper">';
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dbhost');
	$e->name = 'dbhost';
	$e->value = (sess('dbhost')) ?: 'localhost';
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dbuser');
	$e->name = 'dbuser';
	if(sess('dbuser')) $e->value = sess('dbuser');
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dbpass');
	$e->name = 'dbpass';
	if(sess('dbpass')) $e->value = sess('dbpass');
	$e->additional = '<span class="extraLink" id="validateDBConn">'.get_string('validate').'</span>';
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dbname');
	$e->name = 'dbname';
	if(sess('dbname')) $e->value = sess('dbname');
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('dbprefix');
	$e->name = 'dbprefix';
	$e->value = (sess('dbprefix')) ?: 'slm_';
	$output .= form_input($e); 
	
	$output .= '</div>';
	echo $output;
}

function process_level_4() {
	if(validate_param('dbhost','dbuser','dbpass','dbname','dbprefix')) {
		$clevel = 5;
	} else {
		$clevel = 4;
	}
	
	set_sess('current_level', $clevel);
}

function get_level_5() {
	$output = '<p>'.get_string('level5note').'</p>';
	$output .= '<div id="formWrapper">';
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('fullname');
	$e->name = 'fullname';
	if(sess('fullname')) $e->value = sess('fullname');
	$output .= form_input($e); 
	
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('username');
	$e->name = 'username';
	if(sess('username')) $e->value = sess('username');
	$output .= form_input($e);  
		
	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('password');
	$e->name = 'password';
	if(sess('password')) $e->value = sess('password');
	$output .= form_input($e); 

	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('email');
	$e->name = 'email';
	if(sess('email')) $e->value = sess('email');
	$output .= form_input($e); 

	$e = new stdClass();
	$e->type = 'text';
	$e->label = get_string('mobile');
	$e->name = 'mobile';
	if(sess('mobile')) $e->value = sess('mobile');
	$output .= form_input($e); 	
	
	$output .= '</div>';
	echo $output;
}

function process_level_5() {
	if(validate_param('fullname','username','password','email','mobile')) {
		$clevel = 6;
	} else {
		$clevel = 5;
	}
	
	if(create_db_tables()) {
		$adminUser = [
			"full_name"  => sess('fullname'),
			"mobile"      => sess('mobile'),
			"email"       => sess('email'),
			"username"    => sess('username'),
			"password"    => password_hash(sess('password'), PASSWORD_BCRYPT)
		];
		insert_admin_user($adminUser);
		
		generate_config_file();
		
		set_sess('current_level', $clevel);
	}
}

function get_level_6() {
	
}

function process_level_6() {
	$clevel = 6;
	if(admin_user_exists()) {
		if(admin_role_exists()) {
			$clevel = 7;
		}
	}
	set_sess('current_level', $clevel);
}

function admin_role_exists($notif = true) {
	$conn = get_db_conn();
	if($conn) {
		$conn->select_db(sess('dbname'));
		$sql = "SELECT 1 FROM ".sess('dbprefix')."admin_role WHERE title = ? LIMIT 1";
		$stmt = $conn->prepare($sql);

		$title = 'admin';
		$stmt->bind_param("s", $title);
		$stmt->execute();
		$stmt->store_result();

		$exists = $stmt->num_rows > 0;

		$stmt->close();
		if($exists) {
			return true;
		} elseif($notif) {
			set_notif(get_string('adminrolenotexists'));
		}
	}
	return false;
}

function admin_user_exists($notif = true) {
	$conn = get_db_conn();
	if($conn) {
		$conn->select_db(sess('dbname'));
		$sql = "SELECT 1 FROM ".sess('dbprefix')."admin_user WHERE username = ? LIMIT 1";
		$stmt = $conn->prepare($sql);

		$username = sess('username');
		$stmt->bind_param("s", $username);
		$stmt->execute();
		$stmt->store_result();

		$exists = $stmt->num_rows > 0;

		$stmt->close();
		if($exists) {
			return true;
		} elseif($notif) {
			set_notif(get_string('adminusernotexists'));
		}
	}
	return false;
}

function get_level_7() {
	$output = '<p>'.get_string('level7note').'</p>';
	echo $output;
	
}

function check_download_requirements() {
	$checks = [];
	
	$checks['curl'] = extension_loaded('curl');
		
	$checks['zip'] = extension_loaded('zip');
	
	if($checks['curl']) {
		$host = "https://salamcms.ir";
		
		$ch = curl_init($host);
		curl_setopt($ch, CURLOPT_NOBODY, true);        
		curl_setopt($ch, CURLOPT_TIMEOUT, 5); 
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

		curl_exec($ch);
		$httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		$err      = curl_errno($ch);

		$checks['salamcmsir'] = ($err === 0 && $httpcode > 0);
		curl_close($ch);
	}
	
	return $checks;
}

function validate_param(...$keys) {
    foreach ($keys as $key) {
        if (!req($key)) {
            set_notif(get_string('missedparam', ['v1' => get_string($key)]));
            return false;
        } else {
			if(validate_value($key)) {
				set_sess($key, req($key));
			} else {
				set_notif(get_string('invalidvalue', ['v1' => get_string($key)]));
				return false;
			}
		}
    }
    return true;
}

function validate_value($key) {
	switch($key) {
		case 'wwwroot':
		case 'dataroot':
			if(is_dir(req($key))) {
				if (is_readable(req($key))) {
					return true;
				}
			}
			break;
		case 'username':
			return preg_match('/^[a-zA-Z][a-zA-Z0-9_]{2,19}$/', req($key));
			break;
		case 'mobile':
			return preg_match('/^09[0-9]{9}$/', req($key));
			break;
		case 'prefix':
			return preg_match('/^[a-zA-Z][a-zA-Z0-9_]{0,4}_$/', req($key));
			break;
		case 'email':
			return filter_var(req($key), FILTER_VALIDATE_EMAIL) !== false;
			break;
		case 'url':
			return filter_var(req($key), FILTER_VALIDATE_URL) !== false;
			break;
		default:
			return true;
			break;
	}
	
	return false;
}

function show_body_content() {
	global $clevel;
	
	$functionName = 'get_level_' . $clevel;
	if (function_exists($functionName)) {
		$result = $functionName();
		echo $result;
	}
}

function form_input($e) {
	$output = '<div class="formInput">';
	$output .= '<div class="inputLabel">'.$e->label.'</div>';
	$output .= '<div class="inputDiv">';
	switch($e->type) {
		case 'select':
			$output .= select_input($e);
			break;
		case 'text':
			$output .= text_input($e);
			break;
	}
	if(isset($e->additional))
		$output .= $e->additional;
	$output .= '</div>';
	$output .= '</div>';
	
	return $output;
}

function text_input($e) {
	$value = (isset($e->value) && $e->value !='') ? $e->value : '';
	$output = '<input type="text" name="'.$e->name.'" class="textInput" value="'.$value.'" >';
	
	return $output;
}

function select_input($e) {	
	$output = '<select name="'.$e->name.'" class="selectInput">';
	foreach($e->options as $value => $title) {
		$output .= '<option value="'.$value.'">'.$title.'</option>';
	}
	$output .= '</select>';
	if(isset($e->value) && $e->value !='')
		$output .= '<script>set_input_value("'.$e->name.'","'.$e->value.'")</script>';
	
	return $output;
}

function show_back_btn() {
	global $clevel;
	
	if($clevel > 1)
		echo '<a id="backLevel" href="?clevel='.($clevel-1).'">'.get_string('back').'</a>';
}

function show_next_btn() {
	global $clevel;
	
	if($clevel != 7) {
		echo '<button type="submit" id="nextLevel">'.get_string('next').'</button>';
	} else {
		echo '<button type="button" id="finishInstall">'.get_string('finish').'</button>';
	}
}

function check_php_version($php_ver) {
	if (version_compare(PHP_VERSION, $php_ver, '>=')) {
		return true;
	} else {
		set_notif(get_string('phpversionerror', ['v1'=>PHP_VERSION , 'v2'=>$php_ver]));
		return false;
	}
}

function ajax_path_validator() {
	$output = array();
	$output['path'] = req('path');
	if(is_dir(req('path'))) {
		if (is_readable(req('path'))) {
			$output['message'] = get_string('pathisok');
		} else {
			$output['message'] = get_string('pathnotreadable');
		}
	} else {
		$output['message'] = get_string('pathnotok');
	}
	return $output;
}

function ajax_check_db_conn() {
	$output = array();
	$host = req('host');
	$user = req('username');
	$pass = req('password');
	
	if(check_db_conn($host, $user, $pass)) {
		$output['message'] = get_string('dbconnok');
	} else {
		$output['message'] = get_string('nodbconn');
		$output['has_error'] = 'yes';
	}
	
	return $output;
}

function check_db_conn($host, $user, $pass) {
	try {
        $mysqli = @new mysqli($host, $user, $pass);
        if ($mysqli->connect_error) {
			return false;
        } else {
			return true;
		}
    } catch (Exception $e) {
		return false;
    }
	
	return false;
}

function get_db_conn() {
	$host = sess('dbhost');
	$user = sess('dbuser');
	$pass = sess('dbpass');
	
	$conn = @new mysqli($host, $user, $pass);
	if ($conn->connect_error) { 
		return false;
	} else {
		return $conn;
	}
}

function create_db_tables() {

	$dbname = sess('dbname');
	$prefix = sess('dbprefix');
	
	try {
		$conn = get_db_conn();
		if($conn) {
			$conn->query("CREATE DATABASE IF NOT EXISTS `$dbname`");
			$conn->select_db($dbname);

			$xml_string = load_db_xml();
			$xml = simplexml_load_string($xml_string);

			foreach ($xml->table as $table) {
				$tableName = strtolower($prefix . (string) $table['name']);
				$columns = [];
				$indexes = [];

				foreach ($table->column as $column) {
					$name = strtolower((string) $column['name']);
					$type = (string) $column['type'];
					$extra = (string) $column['extra'];

					$colDef = "`$name` $type";
					if ($extra) {
						$colDef .= " $extra";
					}
					$columns[] = $colDef;
				}

				foreach ($table->index as $index) {
					$idxName = (string) $index['name'];
					$idxType = strtolower((string) $index['type']);
					$idxCols = strtolower((string) $index['columns']);

					if ($idxType === "unique") {
						$indexes[] = "UNIQUE KEY `$idxName` (`$idxCols`)";
					} else {
						$indexes[] = "KEY `$idxName` (`$idxCols`)";
					}
				}
				
				$definitions = array_merge($columns, $indexes);

				$sql = "CREATE TABLE IF NOT EXISTS `$tableName` (" . implode(", ", $definitions) . ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;";						
				$conn->query($sql);
			}
			$conn->close();
			
			set_notif(get_string('dbcreated'), 'success');
			return true;
		}
	} catch (Exception $e) {
		set_notif(get_string('error', ['v1' => $e->getMessage()]));
		return false;
	}
}

function insert_admin_user($data) {
	try {
		if(!admin_user_exists(false)) {
			$conn = get_db_conn();
			if($conn) {
				$conn->select_db(sess('dbname'));
				
				$table = sess('dbprefix') . "admin_user";
				$sql = "INSERT INTO `$table` 
					(full_name, mobile, email, username, password, role_ids, create_time, last_login, note, status)
					VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

				$stmt = $conn->prepare($sql);
				if (!$stmt) {
					throw new Exception($conn->error);
				}

				$role_ids   = '1';
				$create_time = date('Y-m-d H:i:s');
				$last_login  = 0;
				$note        = '';
				$status      = 'active';

				$stmt->bind_param(
					"sssssssiss", 
					$data['full_name'], 
					$data['mobile'], 
					$data['email'], 
					$data['username'], 
					$data['password'],
					$role_ids, 
					$create_time, 
					$last_login, 
					$note, 
					$status
				);

				$stmt->execute();
				
				set_notif(get_string('adminusercreated'), 'success');
			}
		}
	} catch (Exception $e) {
		set_notif(get_string('error', ['v1' => $e->getMessage()]));
		return false;
	}
}

function generate_config_file() {
    $config = "<?php  // SalamCMS configuration file\n\n";
    $config .= "unset(\$CFG);\n";
    $config .= "global \$CFG;\n";
    $config .= "\$CFG = new stdClass();\n\n";

    // Main DB settings
    $config .= "\$CFG->dblibrary = 'native';\n";
    $config .= "\$CFG->dbhost    = '".sess('dbhost')."';\n";
    $config .= "\$CFG->dbname    = '".sess('dbname')."';\n";
    $config .= "\$CFG->dbuser    = '".sess('dbuser')."';\n";
    $config .= "\$CFG->dbpass    = '".sess('dbpass')."';\n";
    $config .= "\$CFG->prefix    = '".sess('dbprefix')."';\n";
   
    // Web + data settings
    $config .= "\$CFG->url       = '".sess('url')."';\n";
    $config .= "\$CFG->wwwroot   = '".sess('wwwroot')."';\n";
    $config .= "\$CFG->dataroot  = '".sess('dataroot')."';\n";

    if(file_put_contents('config.php', $config)) {
		set_notif(get_string('configfilecreated'), 'success');
	}
    return true;
}

function get_versions() {
	$versions = array();
	#v1.0.0
	$versions['v1'] = array(
		'id' => 'v1',
		'title' => 'V1.0.0',
		'requirement' => array(
			'php' => 7.4
		)
	);
	
	#v2.0.0
	$versions['v2'] = array(
		'id' => 'v2',
		'title' => 'V2.0.0',
		'requirement' => array(
			'php' => 8.4
		)
	);
	return $versions;
}

function get_menu_items() {
	return array(
		1 => get_string('salam'),
		2 => get_string('projectinfo'),
		3 => get_string('downloadfiles'),
		4 => get_string('dbconnections'),
		5 => get_string('adminuser'),
		6 => get_string('install'),
		7 => get_string('bye')
	);
}

function generate_js_dictionary() {
    global $dict;
    
    $output  = "<script>\n";
    $output .= 'const lang = "' . sess('lang') . '";' . "\n";
    $output .= "const strings = {\n";
    
    $langs = [];
    foreach ($dict as $lang => $string) {
        $entries = [];
        foreach ($string as $key => $val) {
            $entries[] = json_encode($key) . ': ' . json_encode($val);
        }
        $langs[] = json_encode($lang) . ': {' . implode(",\n", $entries) . '}';
    }
    $output .= implode(",\n", $langs);
    
    $output .= "\n};\n";
    $output .= "function get_string(key) {\n";
    $output .= "  return strings[lang][key] || '[['+key+']]';\n";
    $output .= "}\n";
    $output .= "</script>\n";
    
    echo $output;
}

function load_db_xml() {
	$xml_string = <<<XML
<?xml version="1.0" encoding="UTF-8"?>
<database name="slm_cms">
  <table name="admin_user">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="full_name" type="VARCHAR(255)"/>
    <column name="mobile" type="VARCHAR(20)"/>
    <column name="email" type="VARCHAR(150)"/>
    <column name="username" type="VARCHAR(100)"/>
    <column name="password" type="VARCHAR(255)"/>
    <column name="role_ids" type="TEXT"/>
    <column name="create_time" type="DATETIME"/>
    <column name="last_login" type="INT(11)"/>
    <column name="note" type="TEXT"/>
    <column name="status" type="VARCHAR(40)"/>
	
	<index name="idx_username" type="unique" columns="username"/>
  </table>

  <table name="config">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="key" type="VARCHAR(100)"/>
    <column name="value" type="TEXT"/>
    <column name="status" type="VARCHAR(40)"/>
	
	<index name="idx_key" type="unique" columns="key"/>
  </table>

  <table name="plugin">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="slug" type="VARCHAR(255)"/>
    <column name="type" type="VARCHAR(50)"/>
    <column name="version" type="VARCHAR(20)"/>
    <column name="relations" type="JSON"/>
    <column name="create_at" type="DATETIME"/>
    <column name="status" type="VARCHAR(40)"/>
	
	<index name="idx_slug" type="unique" columns="slug"/>
  </table>

  <table name="plugin_config">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="plugin_id" type="INT"/>
    <column name="key" type="VARCHAR(100)"/>
    <column name="value" type="TEXT"/>
    <column name="status" type="VARCHAR(40)"/>
	
    <index name="idx_plugin_id" type="index" columns="plugin_id"/>
    <index name="idx_key" type="index" columns="key"/>	
  </table>

  <table name="data">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="title" type="VARCHAR(150)"/>
    <column name="parent_id" type="INT"/>
    <column name="value" type="TEXT"/>
    <column name="note" type="TEXT"/>
    <column name="data_type_id" type="INT"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="data_type">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="title" type="VARCHAR(100)"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="system_notification">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="type" type="VARCHAR(50)"/>
    <column name="body" type="TEXT"/>
    <column name="buttons" type="JSON"/>
    <column name="create_at" type="DATETIME"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="media">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="name" type="VARCHAR(150)"/>
    <column name="tags" type="TEXT"/>
    <column name="path" type="VARCHAR(255)"/>
    <column name="mime_type" type="VARCHAR(100)"/>
    <column name="size" type="INT"/>
    <column name="password" type="VARCHAR(255)"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="job">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="title" type="VARCHAR(150)"/>
    <column name="command" type="TEXT"/>
    <column name="schedule" type="VARCHAR(100)"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="admin_role">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="title" type="VARCHAR(100)"/>
    <column name="created_at" type="DATETIME"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="admin_role_permission">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="admin_role_id" type="INT"/>
    <column name="permission_slug" type="VARCHAR(150)"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>

  <table name="permission">
    <column name="id" type="INT" extra="AUTO_INCREMENT PRIMARY KEY"/>
    <column name="slug" type="VARCHAR(150)"/>
    <column name="section" type="VARCHAR(100)"/>
    <column name="action" type="VARCHAR(50)"/>
    <column name="note" type="TEXT"/>
    <column name="status" type="VARCHAR(40)"/>
  </table>
</database>
XML;
	return $xml_string;
}
?>